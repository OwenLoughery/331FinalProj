---
title: "331Final"
author: "Owen Loughery, Lenka Masic, Catherine Mispagel, Owen Gresko"
format: 
  html:
    embed-resources: true
    code-tools: true
    toc: true
    number-sections: true
    code-fold: true
editor: source
execute: 
  error: true
  echo: true
  message: false
  warning: false
---


```{r}
library(tidyverse)
library(knitr)
library(gganimate)
library(gifski)
library(broom)
library(kableExtra)
```

Reading in Data Sets:

```{r}
fertility <- read.csv("children_per_woman_total_fertility.csv")
school <- read.csv("mean_years_in_school_women_of_reproductive_age_15_to_44.csv")

```

**Data and Variable Description:**

The two variables we have chosen to explore from GapMinder are babies per woman, found in the child_per_women_total_fertility data set, and the mean years in school (women ages 15-44), found in the mean_years_in_school_women_of_reproductive_age_15_to_44 data set. We are curious to see how mean years in school compares to the number of children women have across the world. The babies per woman variable is the number of children that would be born to a woman should she live through her childbearing years and bear children in accordance with age-specific fertility rates of the specified year. Overall, it is the statistical indicator of total fertility rate (GapMinder). The mean years in school variable is the average number of years of school attended by women of reproductive age, ages 15-44. Schooling that is accounted for in the years includes primary, secondary, and tertiary education (GapMinder). Data is taken across years in both data sets including 175 countries in the years in school school data set and 197 countries in the children per woman data set. Data contain no missing values, however, the data sets do not include the same observations (i.e. countries) and the same range of years.

**Hypothesized Relationship Between Variables:**

We expect the hypothesized relationship between mean years of schooling for women aged 15-44 and babies per woman (total fertility rate) to be strongly negative. We believe that an increase in years of schooling will be associated with a decrease in the amount of children per woman. With increased education, women are better informed on birth control and other contraception methods. Additionally, schools often provide resources such as birth control, meaning women who have been to school have had greater access to resources. An education also opens up career opportunities for women. Women who have developed careers often have less time to have children in their child bearing years. Lastly, cultural differences also affect the total fertility rate. Areas and countries where women don’t typically receive an education or much schooling tend to have gender roles that depict women as mothers before all else, which could encourage more births.

## 1.1 Data Cleaning

```{r}
school <- school |> #Cleaning school df
  pivot_longer( #pivoting long to make years as rows instead of columns
    cols = starts_with("X"),
    names_to = "year",
    values_to = "mean_years_in_school"
  ) |>
  mutate(year = str_remove(year, "X")) #cleaning year variable
```

## 1.2 Pivot Longer
```{r}

fertility <- fertility |> #Cleaning fertility df
  pivot_longer( #pivoting long to make years as rows instead of columns
    cols = starts_with("X"),
    names_to = "year",
    values_to = "babies_per_woman"
  ) |>
  mutate(year = str_remove(year, "X"))  #cleaning year variable
```

## 1.3 Joining Datasets
```{r}
school_fertility_df <- school |> #Joining two data sets
  inner_join(fertility, #Using inner join because we want to compare relationship between the two variables so do not want missing values
             by = c("country", "year"))
fertility

school_fertility_df <- school_fertility_df |> #making year and country as categorical variables
  mutate(year = fct(year),
         country = fct(country))

head(school_fertility_df) |>
  kable()
```

**Data Cleaning Process and Decisions:**

We decided to start by using a pivot long to transform the school dataset into the format we want it to be in. This step will allow us to have each year as a row instead of a column, which will make data visualization much easier and will allow us to make GIFs of plots over time. We also have a line of code to clean the year variable. We did the same thing for our babies per woman dataset- pivoting long to make the years rows. Once we cleaned both datasets, we decided to use an inner join because we want to compare relationships between the two variables without missing values- they’d just get in the way. After the join, we have code to make year and country categorical variables- allowing for easier grouping, leading to cleaner visualization. Lastly, we made sure that we had the cleaned dataset in correctly by utilizing kable to view the first few rows.

#########################
## TO DO FOR PC4
WRITTEN COMPONENTS:
1. Present and discuss visualizations of the relationship between the variables.
2. Describe the statistical method used – linear regression.
3. Present the estimated regression model (in notation).
4. Interpret the linear regression coefficients (in context).
5. Describe the fit of the regression model (both in table and written format).

OTHER:
- 2.2: Provide interpretations for each of the coefficients in linear regression)
- 2.2 - Discuss decision of summarizing data so that there is one value per country (took mean over years)
- 2.3 Discuss the proportion of the variability in the response values that was accounted for by your regression model. What does this suggest about the “quality” of your model?
#####################

## 2.1 Data Visualization
```{r}
school_fertility_df <- school_fertility_df |>
  mutate(Continent = fct_recode(country, "Asia" = "Afghanistan", "Africa" = "Angola", "Europe" = "Albania", "Asia" = "UAE", 
  "South America" = "Argentina", "Europe" = "Armenia", "North America" = "Antigua and Barbuda", 
  "Australia" = "Australia", "Europe" = "Austria", "Asia" = "Azerbaijan", "Africa" = "Burundi", 
  "Europe" = "Belgium", "Africa" = "Benin", "Africa" = "Burkina Faso", "Asia" = "Bangladesh", 
  "Europe" = "Bulgaria", "Asia" = "Bahrain", "North America" = "Bahamas", "Europe" = "Bosnia and Herzegovina", 
  "Europe" = "Belarus", "North America" = "Belize", "South America" = "Bolivia", "South America" = "Brazil", 
  "Africa" = "Botswana", "Africa" = "Central African Republic", "North America" = "Canada", 
  "Europe" = "Switzerland", "South America" = "Chile", "Asia" = "China", "Africa" = "Cote d'Ivoire", 
  "Africa" = "Cameroon", "Africa" = "Congo, Dem. Rep.", "Africa" = "Congo, Rep.", "South America" = "Colombia", 
  "Africa" = "Comoros", "Africa" = "Cape Verde", "North America" = "Costa Rica", "North America" = "Cuba", 
  "Europe" = "Cyprus", "Europe" = "Czech Republic", "Europe" = "Germany", "Africa" = "Djibouti", 
  "Europe" = "Denmark", "North America" = "Dominican Republic", "Africa" = "Algeria", 
  "South America" = "Ecuador", "Africa" = "Egypt", "Africa" = "Eritrea", "Europe" = "Spain", 
  "Europe" = "Estonia", "Africa" = "Ethiopia", "Europe" = "Finland", "Australia" = "Fiji", "Europe" = "France", 
  "Africa" = "Gabon", "Europe" = "UK", "Europe" = "Georgia", "Africa" = "Ghana", "Africa" = "Guinea", 
  "Africa" = "Gambia", "Africa" = "Guinea-Bissau", "Africa" = "Equatorial Guinea", "Europe" = "Greece", 
  "North America" = "Guatemala", "South America" = "Guyana", "North America" = "Honduras", "Europe" = "Croatia", 
  "North America" = "Haiti", "Europe" = "Hungary", "Asia" = "Indonesia", "Asia" = "India", 
  "Europe" = "Ireland", "Asia" = "Iran", "Asia" = "Iraq", "Asia" = "Israel", "Europe" = "Italy", 
  "North America" = "Jamaica", "Asia" = "Jordan", "Asia" = "Japan", "Asia" = "Kazakhstan", "Africa" = "Kenya", 
  "Asia" = "Kyrgyz Republic", "Asia" = "Cambodia", "Australia" = "Kiribati", "Asia" = "South Korea", 
  "Asia" = "Kuwait", "Asia" = "Lao", "Asia" = "Lebanon", "Africa" = "Liberia", "North America" = "St. Lucia", 
  "Asia" = "Sri Lanka", "Africa" = "Lesotho", "Europe" = "Lithuania", "Europe" = "Luxembourg", 
  "Europe" = "Latvia", "Africa" = "Morocco", "Europe" = "Moldova", "Africa" = "Madagascar", 
  "Asia" = "Maldives", "North America" = "Mexico", "Australia" = "Marshall Islands", "Europe" = "North Macedonia", 
  "Africa" = "Mali", "Asia" = "Myanmar", "Europe" = "Montenegro", "Asia" = "Mongolia", 
  "Africa" = "Mozambique", "Africa" = "Mauritania", "Africa" = "Mauritius", "Africa" = "Malawi", 
  "Asia" = "Malaysia", "Africa" = "Namibia", "Africa" = "Niger", "Africa" = "Nigeria", 
  "North America" = "Nicaragua", "Europe" = "Netherlands", "Europe" = "Norway", "Asia" = "Nepal", 
  "Australia" = "New Zealand", "Asia" = "Oman", "Asia" = "Pakistan", "North America" = "Panama", 
  "South America" = "Peru", "Asia" = "Philippines", "Australia" = "Papua New Guinea", "Europe" = "Poland", 
  "Europe" = "Portugal", "South America" = "Paraguay", "Asia" = "Palestine", "Asia" = "Qatar", 
  "Europe" = "Romania", "Europe" = "Russia", "Africa" = "Rwanda", "Asia" = "Saudi Arabia", "Africa" = "Sudan", 
  "Africa" = "Senegal", "Asia" = "Singapore", "Australia" = "Solomon Islands", "Africa" = "Sierra Leone", 
  "North America" = "El Salvador", "Africa" = "Somalia", "Europe" = "Serbia", "Africa" = "Sao Tome and Principe", 
  "South America" = "Suriname", "Europe" = "Slovak Republic", "Europe" = "Slovenia", "Europe" = "Sweden", 
  "Africa" = "Eswatini", "Africa" = "Seychelles", "Asia" = "Syria", "Africa" = "Chad", "Africa" = "Togo", 
  "Asia" = "Thailand", "Asia" = "Tajikistan", "Asia" = "Turkmenistan", "Asia" = "Timor-Leste", 
  "Australia" = "Tonga", "North America" = "Trinidad and Tobago", "Africa" = "Tunisia", "Asia" = "Turkey", 
  "Asia" = "Taiwan", "Africa" = "Tanzania", "Africa" = "Uganda", "Europe" = "Ukraine", "South America" = "Uruguay", 
  "North America" = "USA", "Asia" = "Uzbekistan", "South America" = "Venezuela", "Asia" = "Vietnam", 
  "Australia" = "Vanuatu", "Australia" = "Samoa", "Asia" = "Yemen", "Africa" = "South Africa", 
  "Africa" = "Zambia", "Africa" = "Zimbabwe"))
```

```{r}
#DOUBLE CHECK VISUAL
school_fertility_df |>
  group_by(country, Continent) |>
  summarize(
    avg_babies = mean(babies_per_woman),
    avg_years = mean(mean_years_in_school)) |>
  ggplot(aes(x = avg_years, y = avg_babies)) + 
  geom_point(aes(color = Continent), size = 1, alpha = 0.8) + 
  geom_smooth(method = "lm") +
  labs(x = "Average Mean Years in School", y = "", subtitle = "Average Babies per Woman",
       title = "Average Babies per Woman vs. Average Mean Years in School Across Years for 175 Countries in the World") +
  scale_x_continuous(breaks = seq(0, 15, by = 3)) +
  scale_y_continuous(breaks = seq(0, 10, by = 2))
  
```
```{r}
#FIX YEAR LABEL
#GET RID OF GRAY FOR LINE
#Visual 2
visual_2 <- school_fertility_df |>
  mutate(year = as.numeric(year)) |>
  group_by(year, country) |>
  ggplot(aes(x = mean_years_in_school, y = babies_per_woman)) +
  geom_point(aes(color = Continent), alpha = 0.7) +
  geom_smooth(method = "lm") +
  labs(title = 'Babies Per Woman vs. Mean Years in School by Continent for 175 Countries in Year {closest_state}', x = "Mean Years in School", y = "", subtitle = "Babies Per Woman") +
  transition_states(as.factor(year), transition_length = 1, state_length = 1) +
  ease_aes("linear") +
scale_x_continuous(breaks = seq(0, 
15, by = 3)) +
  scale_y_continuous(breaks = seq(0, 9, by = 1.5))

animation <- animate(visual_2, nframes = 100, fps = 10, renderer = gifski_renderer(), width = 600, height = 500)

anim_save("fertility_education.gif", animation)
cat('<img src="fertility_education.gif" alt="Fertility vs Education Animation" />')

```

## 2.2 Linear Regression
```{r}
country_summary <- school_fertility_df |>
  group_by(country) |>
  summarise(avg_school = mean(mean_years_in_school),
         avg_babies = mean(babies_per_woman))

lin_reg <- lm(data = country_summary, avg_babies ~ avg_school)

summary_lin_reg <- tidy(lin_reg, conf.int = TRUE)
summary_lin_reg |>
  kable(col.names = c("Term", "Estimate", "Std. Error", "Statistic", "P-value", "Conf. Low", "Conf. High"), 
        caption = "Linear Regression of Average of Babies on Average of Mean Years of Schooling") |>
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## 2.3 Model Fit
```{r}
#MAKE TITLE BETTER
#MAKE INTERACTIVE w/ DT PACKAGE?
var_table <- country_summary |>
  summarise(
    var_resp = var(avg_babies, na.rm = TRUE),
    var_fit = var(fitted(lin_reg), na.rm = TRUE),
    var_resid = var(residuals(lin_reg), na.rm = TRUE))
 
var_table |>
kable(col.names = c("Response Variance", "Fitted Values Variance", "Residuals Variance"), 
        caption = "Variance of Data") |>
  kable_styling(bootstrap_options = c("striped", "hover"))

```